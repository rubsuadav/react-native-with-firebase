name: Tests CI 😁
on:
  push:
    branches: ["master", "testing"]
  pull_request:
    branches: ["master"]
jobs:
  cypress-run:
    runs-on: ubuntu-latest
    name: E2E testing with Cypress
    steps:
      - name: Setup Node
        uses: actions/setup-node@v3
      - name: Checkout code 🔎
        uses: actions/checkout@v3

      - name: Cache central NPM modules 📦
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ github.ref }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ github.ref }}-${{ hashFiles('**/package-lock.json') }}

      - name: Cache Cypress binary ⚙️
        uses: actions/cache@v3
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-cypress-${{ github.ref }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            cypress-${{ runner.os }}-cypress-${{ github.ref }}-${{ hashFiles('**/package-lock.json') }}

      - name: Cache local node_modules 📦
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ github.ref }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-${{ github.ref }}-

      - name: Install Firebase CLI 🥳
        run: npm install -g firebase-tools

      - name: Install dependencies 🥳
        run: |
          npm ci
          npx cypress cache path
          npx cypress cache list
          npx cypress verify
          npx cypress info
          npm run predeploy

      - name: Firebase Login and run emulators with Cypress (tests E2E)🔑
        uses: w9jds/firebase-action@master
        with:
          args: emulators:exec 'npm i cypress && npm test'
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
